<!-- NRCA Interactive Retail Mapper -->
<!-- Modular structure with separate data loading -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NRCA Retail Intelligence Mapper</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1f3a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .header-bar {
            background: #1a1f3a;
            border-bottom: 3px solid #32d46e;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 15px rgba(50, 212, 110, 0.15);
            gap: 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 0 0 auto;
        }

        .nrca-logo {
            width: 50px;
            height: 50px;
            filter: drop-shadow(0 2px 4px rgba(0, 166, 81, 0.3));
        }

        .tagline-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tagline-main {
            font-size: 18px;
            font-weight: bold;
            color: #32d46e;
            letter-spacing: 2px;
        }

        .tagline-sub {
            font-size: 11px;
            color: #a0b0d0;
            letter-spacing: 0.5px;
        }

        .sticky-filters-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            overflow-x: auto;
        }

        .sticky-label {
            font-size: 12px;
            color: #32d46e;
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.5px;
        }

        .sticky-pill {
            background: rgba(50, 212, 110, 0.2);
            border: 1px solid #32d46e;
            color: #32d46e;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .sticky-pill-close {
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .sticky-pill-close:hover {
            opacity: 0.6;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .left-panel {
            width: 350px;
            background: #232b4a;
            border-right: 2px solid #2a3a5a;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }

        .left-panel h2 {
            color: #32b4c6;
            font-size: 14px;
            margin-top: 20px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #32b4c6;
            padding-bottom: 8px;
        }

        .left-panel h2:first-child {
            margin-top: 0;
        }

        .tactical-area-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 15px;
        }

        .tactical-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }

        .tactical-item:hover {
            background: #2a3a5a;
        }

        .tactical-item input {
            margin-right: 10px;
            cursor: pointer;
        }

        .available-retailers {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 300px;
            overflow-y: auto;
            background: #1a2340;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .retailer-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
            border-left: 2px solid #32b4c6;
        }

        .retailer-option:hover {
            background: #2a3a5a;
        }

        .retailer-option input {
            margin-right: 10px;
            cursor: pointer;
        }

        .retailer-count {
            color: #32b4c6;
            font-size: 10px;
        }

        .force-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: #1a2340;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .force-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .force-item:hover {
            background: #2a3a5a;
        }

        .force-item input {
            margin-right: 10px;
            cursor: pointer;
        }

        .quick-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-btn {
            flex: 1;
            padding: 8px 12px;
            background: #32b4c6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .quick-btn:hover {
            background: #2a9aad;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            background: #1a2340;
            border: 1px solid #32b4c6;
            border-radius: 5px;
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .search-box::placeholder {
            color: #808090;
        }

        .area-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-box {
            background: #1a2340;
            padding: 12px;
            border-radius: 5px;
            border-left: 2px solid #32b4c6;
        }

        .stat-label {
            font-size: 11px;
            color: #a0b0d0;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #32b4c6;
        }

        .results-list {
            flex: 0.45;
            background: #1a1f3a;
            border-top: 2px solid #2a3a5a;
            overflow-y: auto;
            padding: 20px;
            min-height: 250px;
        }

        .results-header {
            color: #32b4c6;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #32b4c6;
        }

        .result-item {
            background: #232b4a;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 3px solid #32b4c6;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .result-item:hover {
            background: #2a3a5a;
            transform: translateX(5px);
        }

        .result-name {
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        .result-info {
            color: #a0b0d0;
            font-size: 11px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #2a3a5a;
            border-top: 4px solid #32b4c6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #32b4c6;
            margin-top: 15px;
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a2340;
        }

        ::-webkit-scrollbar-thumb {
            background: #32b4c6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a9aad;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text">Loading Retailer Data...</div>
        </div>
    </div>

    <div class="header-bar">
        <div class="logo-section">
            <svg class="nrca-logo" viewBox="0 0 100 100" width="50" height="50">
                <path d="M 50 15 L 75 30 L 75 55 Q 75 75 50 85 Q 25 75 25 55 L 25 30 Z" 
                      fill="none" stroke="#32d46e" stroke-width="2.5" stroke-linejoin="round"/>
                <g id="starburst" stroke="#32d46e" stroke-width="2" stroke-linecap="round">
                    <line x1="50" y1="8" x2="50" y2="35"/><line x1="50" y1="65" x2="50" y2="92"/>
                    <line x1="8" y1="50" x2="35" y2="50"/><line x1="65" y1="50" x2="92" y2="50"/>
                    <line x1="18" y1="18" x2="38" y2="38"/><line x1="62" y1="62" x2="82" y2="82"/>
                    <line x1="82" y1="18" x2="62" y2="38"/><line x1="38" y1="62" x2="18" y2="82"/>
                </g>
                <circle cx="50" cy="50" r="12" fill="#32d46e" opacity="0.9"/>
                <text x="50" y="55" text-anchor="middle" font-size="10" font-weight="bold" fill="white">N</text>
            </svg>
            <div class="tagline-section">
                <div class="tagline-main">NRCA</div>
                <div class="tagline-sub">NRCA.CO.UK ‚Ä¢ Retail Intelligence</div>
            </div>
        </div>
        
        <div class="sticky-filters-bar">
            <div class="sticky-label">üîí Active Retailers:</div>
            <div id="stickyFiltersBar"><!-- Sticky filters displayed as pills here --></div>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <h2>üó∫Ô∏è Police Force</h2>
            <div class="quick-buttons">
                <button class="quick-btn" onclick="selectAllForces()">Select All</button>
                <button class="quick-btn" onclick="clearAllForces()">Clear All</button>
            </div>
            <div class="force-list" id="forceList"><!-- Populated by JavaScript --></div>

            <h2>üéØ Tactical Area</h2>
            <div class="tactical-area-list" id="tacticalAreaList">
                <div style="color: #a0b0d0; font-size: 12px;">Select a police force first</div>
            </div>

            <h2>üè™ Retailers</h2>
            <input type="text" id="retailerSearch" class="search-box" placeholder="Search retailers...">
            <div id="availableRetailers" class="available-retailers"><!-- Available retailers populated here --></div>

            <h2>üìä Area Summary</h2>
            <div class="area-stats" id="areaStats">
                <div class="stat-box">
                    <div class="stat-label">Total Retailers</div>
                    <div class="stat-value" id="statRetailers">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">BIDs</div>
                    <div class="stat-value" id="statBIDs">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">BCRPs</div>
                    <div class="stat-value" id="statBCRPs">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ShopWatch</div>
                    <div class="stat-value" id="statShopWatch">0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="map-container"><div id="map"></div></div>
            <div class="results-list">
                <div class="results-header">üìç Showing: <span id="resultsCount">Loading...</span> locations</div>
                <div id="locationsList"><!-- Results populated here --></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.min.js"></script>
    <script src="https://raw.githubusercontent.com/grby-bit/nrca-retail-mapper/main/data/retailers.js"></script>
    <script>
        let map, markerClusterGroup = L.markerClusterGroup();
        let allRetailers = [], selectedForces = new Set(), stickyRetailers = new Set();
        let neighbourhoodMap = {}, allForces = [];

        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupUI();
            loadRetailerData();
        });

        function initMap() {
            map = L.map('map', { center: [54.5, -3.0], zoom: 6, scrollWheelZoom: true });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors', maxZoom: 19
            }).addTo(map);
            map.addLayer(markerClusterGroup);
        }

        function setupUI() {
            if (typeof RETAILERS_DATA === 'undefined') {
                console.error('Retailers data not loaded');
                return;
            }
            
            allForces = Object.keys(RETAILERS_DATA).sort();
            neighbourhoodMap = {};
            
            allForces.forEach(force => {
                neighbourhoodMap[force] = [];
                if (RETAILERS_DATA[force]) {
                    Object.keys(RETAILERS_DATA[force]).forEach(neighbourhood => {
                        if (!neighbourhoodMap[force].includes(neighbourhood)) {
                            neighbourhoodMap[force].push(neighbourhood);
                        }
                    });
                }
            });

            const forceList = document.getElementById('forceList');
            allForces.forEach(force => {
                const label = document.createElement('label');
                label.className = 'force-item';
                label.innerHTML = '<input type="checkbox" data-force="' + force + '"><span>' + force + '</span>';
                label.querySelector('input').addEventListener('change', onForceChange);
                forceList.appendChild(label);
            });

            document.getElementById('retailerSearch').addEventListener('input', updateDisplay);
        }

        function onForceChange() {
            updateTacticalAreas();
            updateAvailableRetailers();
            updateDisplay();
        }

        function updateTacticalAreas() {
            const selectedForces = getSelectedForces();
            const tacticalList = document.getElementById('tacticalAreaList');
            tacticalList.innerHTML = '';

            if (selectedForces.size === 0) {
                tacticalList.innerHTML = '<div style="color: #a0b0d0; font-size: 12px;">Select a police force first</div>';
                return;
            }

            const uniqueNeighbourhoods = new Set();
            selectedForces.forEach(force => {
                if (neighbourhoodMap[force]) {
                    neighbourhoodMap[force].forEach(n => uniqueNeighbourhoods.add(n));
                }
            });

            if (uniqueNeighbourhoods.size === 0) {
                tacticalList.innerHTML = '<div style="color: #a0b0d0; font-size: 12px;">No areas available</div>';
                return;
            }

            Array.from(uniqueNeighbourhoods).sort().forEach(area => {
                const label = document.createElement('label');
                label.className = 'tactical-item';
                label.innerHTML = '<input type="checkbox" data-tactical="' + area + '"><span>' + area + '</span>';
                label.querySelector('input').addEventListener('change', updateAvailableRetailers);
                tacticalList.appendChild(label);
            });
        }

        function updateAvailableRetailers() {
            const selectedForces = getSelectedForces();
            const selectedAreas = Array.from(document.querySelectorAll('input[data-tactical]:checked')).map(cb => cb.dataset.tactical);
            
            if (selectedForces.size === 0) {
                document.getElementById('availableRetailers').innerHTML = '<div style="color: #a0b0d0; font-size: 12px;">Select a force first</div>';
                return;
            }

            const filtered = allRetailers.filter(r => {
                const forceMatch = selectedForces.has(r.police_force);
                const areaMatch = selectedAreas.length === 0 || selectedAreas.includes(r.neighbourhood);
                return forceMatch && areaMatch;
            });

            const countMap = {};
            filtered.forEach(r => {
                countMap[r.name] = (countMap[r.name] || 0) + 1;
            });

            const container = document.getElementById('availableRetailers');
            container.innerHTML = '';
            Object.entries(countMap).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
                const label = document.createElement('label');
                label.className = 'retailer-option';
                label.innerHTML = '<div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" data-retailer="' + name + '" onchange="updateDisplay()"><span>' + name + '</span></div><span class="retailer-count">' + count + '</span>';
                container.appendChild(label);
            });
        }

        function loadRetailerData() {
            try {
                // Extract retailers from RETAILERS_DATA structure
                allRetailers = [];
                Object.keys(RETAILERS_DATA).forEach(force => {
                    Object.keys(RETAILERS_DATA[force]).forEach(neighbourhood => {
                        if (RETAILERS_DATA[force][neighbourhood]) {
                            Object.keys(RETAILERS_DATA[force][neighbourhood]).forEach(retailerName => {
                                allRetailers.push({
                                    name: retailerName,
                                    police_force: force,
                                    neighbourhood: neighbourhood,
                                    postcode: RETAILERS_DATA[force][neighbourhood][retailerName].postcode || 'N/A',
                                    status: 'Open',
                                    latitude: RETAILERS_DATA[force][neighbourhood][retailerName].latitude || 54.5,
                                    longitude: RETAILERS_DATA[force][neighbourhood][retailerName].longitude || -3.0
                                });
                            });
                        }
                    });
                });

                updateDisplay();
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingOverlay').innerHTML = '<div style="text-align: center; color: #ff6b6b;"><div style="font-size: 18px; margin-bottom: 10px;">Error Loading Data</div><div style="color: #32b4c6; font-size: 12px;">' + error.message + '</div></div>';
            }
        }

        function getSelectedForces() {
            const selected = new Set();
            document.querySelectorAll('input[data-force]:checked').forEach(cb => selected.add(cb.dataset.force));
            return selected;
        }

        function updateHeaderBar() {
            const container = document.getElementById('stickyFiltersBar');
            container.innerHTML = '';
            const checked = Array.from(document.querySelectorAll('input[data-retailer]:checked'));
            
            if (checked.length === 0) {
                container.innerHTML = '<div style="color: #808090; font-size: 11px;">No retailers selected</div>';
                return;
            }

            checked.forEach(cb => {
                const pill = document.createElement('div');
                pill.className = 'sticky-pill';
                pill.innerHTML = cb.dataset.retailer + ' <span class="sticky-pill-close" onclick="uncheckRetailer(\'" + cb.dataset.retailer.replace(/'/g, "\\") + "\')" + ">"></span>‚úï</span>';
                container.appendChild(pill);
            });
        }

        function uncheckRetailer(name) {
            const cb = document.querySelector('input[data-retailer="' + name + '"]');
            if (cb) { cb.checked = false; updateDisplay(); }
        }

        function updateDisplay() {
            const selectedForces = getSelectedForces();
            const selectedAreas = Array.from(document.querySelectorAll('input[data-tactical]:checked')).map(cb => cb.dataset.tactical);
            
            stickyRetailers.clear();
            document.querySelectorAll('input[data-retailer]:checked').forEach(cb => stickyRetailers.add(cb.dataset.retailer));

            const filtered = allRetailers.filter(r => {
                const forceMatch = selectedForces.size === 0 || selectedForces.has(r.police_force);
                const areaMatch = selectedAreas.length === 0 || selectedAreas.includes(r.neighbourhood);
                const retailerMatch = stickyRetailers.size === 0 || stickyRetailers.has(r.name);
                return forceMatch && areaMatch && retailerMatch;
            });

            displayMarkers(filtered);
            displayResultsList(filtered);
            updateResultsCount(filtered.length);
            updateAreaStats(selectedForces);
            updateHeaderBar();
        }

        function updateAreaStats(selectedForces) {
            const inArea = allRetailers.filter(r => selectedForces.size === 0 || selectedForces.has(r.police_force));
            document.getElementById('statRetailers').textContent = inArea.length.toLocaleString();
            document.getElementById('statBIDs').textContent = '0';
            document.getElementById('statBCRPs').textContent = '0';
            document.getElementById('statShopWatch').textContent = '0';
        }

        function displayMarkers(retailers) {
            markerClusterGroup.clearLayers();
            retailers.forEach(r => {
                const marker = L.circleMarker([r.latitude, r.longitude], {
                    radius: 6, fillColor: '#32b4c6', color: '#ffffff', weight: 1, fillOpacity: 0.8
                });
                marker.bindPopup('<strong>' + r.name + '</strong><br>' + r.postcode + '<br>' + r.police_force);
                markerClusterGroup.addLayer(marker);
            });
            
            if (retailers.length > 0) {
                const group = L.featureGroup(markerClusterGroup.getLayers());
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function displayResultsList(retailers) {
            const list = document.getElementById('locationsList');
            list.innerHTML = '';
            retailers.slice(0, 100).forEach(r => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = '<div class="result-name">' + r.name + '</div><div class="result-info">üìç ' + r.postcode + ' | ' + r.police_force + '</div>';
                div.onclick = () => map.setView([r.latitude, r.longitude], 14);
                list.appendChild(div);
            });
            
            if (retailers.length > 100) {
                const more = document.createElement('div');
                more.style.cssText = 'padding: 10px; text-align: center; color: #32b4c6;';
                more.innerHTML = '+' + (retailers.length - 100) + ' more locations...';
                list.appendChild(more);
            }
        }

        function updateResultsCount(count) {
            document.getElementById('resultsCount').textContent = count.toLocaleString() + ' locations';
        }

        function selectAllForces() {
            document.querySelectorAll('input[data-force]').forEach(cb => cb.checked = true);
            onForceChange();
        }

        function clearAllForces() {
            document.querySelectorAll('input[data-force]').forEach(cb => cb.checked = false);
            updateDisplay();
        }
    </script>
</body>
</html>